.PHONY: help start stop status clean install dev

# DomyÅ›lny target
help:
	@echo "ðŸŒŠ System Monitorowania Powodzi - Makefile"
	@echo "==========================================="
	@echo "DostÄ™pne komendy:"
	@echo "  make start    - Uruchom caÅ‚Ä… aplikacjÄ™ (backend + frontend)"
	@echo "  make stop     - Zatrzymaj caÅ‚Ä… aplikacjÄ™"
	@echo "  make status   - SprawdÅº status aplikacji"
	@echo "  make dev      - Uruchom w trybie deweloperskim"
	@echo "  make install  - Zainstaluj zaleÅ¼noÅ›ci"
	@echo "  make clean    - WyczyÅ›Ä‡ cache i pliki tymczasowe"
	@echo "  make help     - PokaÅ¼ tÄ™ pomoc"

# Uruchom caÅ‚Ä… aplikacjÄ™
start:
	@echo "ðŸš€ Uruchamianie systemu monitorowania powodzi..."
	@echo "ðŸ“¦ Uruchamianie backendu (Docker)..."
	docker-compose up -d
	@echo "â³ Czekanie na uruchomienie backendu..."
	sleep 5
	@echo "ðŸŒ Uruchamianie frontendu (Streamlit)..."
	@echo "Frontend bÄ™dzie dostÄ™pny na: http://localhost:8501"
	@echo "Backend API bÄ™dzie dostÄ™pny na: http://localhost:8000"
	streamlit run flood_monitoring/ui/app.py --server.port 8501 --server.headless true &
	@echo "âœ… Aplikacja uruchomiona pomyÅ›lnie!"
	@echo "ðŸ“± OtwÃ³rz przeglÄ…darkÄ™ i przejdÅº do: http://localhost:8501"

# Zatrzymaj caÅ‚Ä… aplikacjÄ™
stop:
	@echo "ðŸ›‘ Zatrzymywanie systemu monitorowania powodzi..."
	@echo "ðŸ”Œ Zatrzymywanie frontendu..."
	-pkill -f "streamlit run flood_monitoring/ui/app.py"
	@echo "ðŸ“¦ Zatrzymywanie backendu (Docker)..."
	docker-compose down
	@echo "âœ… Aplikacja zatrzymana pomyÅ›lnie!"

# SprawdÅº status aplikacji
status:
	@echo "ðŸ“Š Status systemu monitorowania powodzi:"
	@echo "========================================"
	@echo "ðŸ³ Status Docker containers:"
	@docker-compose ps || echo "âŒ Docker nie jest uruchomiony"
	@echo ""
	@echo "ðŸŒ Status Streamlit:"
	@pgrep -f "streamlit run" > /dev/null && echo "âœ… Streamlit dziaÅ‚a" || echo "âŒ Streamlit nie dziaÅ‚a"
	@echo ""
	@echo "ðŸ”— Sprawdzanie poÅ‚Ä…czeÅ„:"
	@curl -s http://localhost:8000/health > /dev/null && echo "âœ… Backend API (port 8000) - OK" || echo "âŒ Backend API (port 8000) - BÅÄ„D"
	@curl -s http://localhost:8501 > /dev/null && echo "âœ… Frontend (port 8501) - OK" || echo "âŒ Frontend (port 8501) - BÅÄ„D"

# Tryb deweloperski
dev:
	@echo "ðŸ”§ Uruchamianie w trybie deweloperskim..."
	@echo "ðŸ“¦ Uruchamianie backendu z hot-reload..."
	docker-compose up -d
	@echo "â³ Czekanie na uruchomienie backendu..."
	sleep 5
	@echo "ðŸŒ Uruchamianie frontendu z hot-reload..."
	streamlit run flood_monitoring/ui/app.py --server.port 8501 --server.runOnSave true

# Instalacja zaleÅ¼noÅ›ci
install:
	@echo "ðŸ“¦ Instalowanie zaleÅ¼noÅ›ci..."
	pip install -e .
	@echo "ðŸ³ Budowanie obrazÃ³w Docker..."
	docker-compose build
	@echo "âœ… Instalacja zakoÅ„czona!"

# Czyszczenie
clean:
	@echo "ðŸ§¹ Czyszczenie cache i plikÃ³w tymczasowych..."
	@echo "ðŸ—‘ï¸ Usuwanie cache Streamlit..."
	-rm -rf ~/.streamlit
	@echo "ðŸ—‘ï¸ Usuwanie plikÃ³w __pycache__..."
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete 2>/dev/null || true
	@echo "ðŸ³ Czyszczenie obrazÃ³w Docker..."
	docker system prune -f
	@echo "âœ… Czyszczenie zakoÅ„czone!"

# Restart aplikacji
restart: stop start
	@echo "ðŸ”„ Aplikacja zostaÅ‚a zrestartowana!"

# Logi aplikacji
logs:
	@echo "ðŸ“‹ Logi backendu (Docker):"
	docker-compose logs -f

# Test aplikacji
test:
	@echo "ðŸ§ª Testowanie aplikacji..."
	@echo "ðŸ” Test backendu..."
	curl -f http://localhost:8000/stations/ > /dev/null && echo "âœ… Backend API dziaÅ‚a" || echo "âŒ Backend API nie dziaÅ‚a"
	@echo "ðŸ” Test frontendu..."
	curl -f http://localhost:8501 > /dev/null && echo "âœ… Frontend dziaÅ‚a" || echo "âŒ Frontend nie dziaÅ‚a"

# Backup danych
backup:
	@echo "ðŸ’¾ Tworzenie kopii zapasowej..."
	mkdir -p backups
	docker-compose exec -T db pg_dump -U postgres flood_monitoring > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Kopia zapasowa utworzona w folderze backups/"
